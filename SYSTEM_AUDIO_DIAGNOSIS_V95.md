# 系统音频录制问题诊断报告 v95

**日期：** 2026-02-08  
**版本：** v95  
**状态：** ✅ 问题已确认，解决方案已实施

---

## 🔍 问题重新诊断

### 之前的错误诊断（v94）
❌ **错误结论：** 认为系统音频完全没录到（0.0%），判断为用户操作问题  
❌ **错误原因：** 只看了部分日志，没有看到后续的 `[BALANCE-BOOST]` 消息

### 正确诊断（v95）
✅ **实际情况：** 系统音频**已录到**，但**音量太小**，转录API无法识别  
✅ **证据：**
```
[BALANCE-BOOST] 只有系统音频，提升至: 0.44 x
[BALANCE-BOOST] 只有系统音频，提升至: 0.52 x
...
[BALANCE-BOOST] 只有系统音频，提升至: 4.62 x
[BALANCE-AGGRESSIVE] 调整系统增益至: 3.67 x (比例: 1.07 → 1.07)
```

**结论：** 检测到系统音频，平衡系统在工作，但增益调整不够快/不够大。

---

## 🐛 根本原因

### 1. 初始增益太低
```javascript
// v93-v94
systemGain.gain.value = 2.0;  // ❌ 太小
```

**问题：** YouTube 10%音量 × 2.0x增益 = 仍然太小

---

### 2. 增益范围限制太严格
```javascript
// v93-v94
const newSystemGain = Math.max(0.3, Math.min(5.0, idealSystemGain));
//                             ↑ 最小0.3x   ↑ 最大5.0x
```

**问题：**
- 当用户说话（麦克风响）时，系统音频被压到 **0.3x（最小值）**
- 然后用户切换到YouTube播放（10%音量），系统需要从0.3x慢慢提升
- 但提升速度（1.2倍/次）太慢，还没升到合适值就结束了

---

### 3. 提升策略太保守
```javascript
// v93-v94
if (systemLevel < 0.3 && systemGain.gain.value < 4.0) {
    systemGain.gain.value = Math.min(5.0, systemGain.gain.value * 1.2);
    //                                ↑ 最大5.0x    ↑ 每次1.2倍
}
```

**问题：**
- 上限 5.0x 太低（YouTube 10%音量需要更大增益）
- 提升速度 1.2倍/100ms 太慢

---

### 4. 测试场景特殊
用户的测试流程：
1. **先说话**（麦克风响） → 系统音频被压到 0.3x
2. **然后播放YouTube 10%** → 系统音频需要从0.3x提升
3. **再说话** → 系统音频又被压下去

**结果：** 系统音频在整个录音过程中，增益都不够，最终混合音频中占比太小。

---

## ✅ 解决方案（v95）

### 修改1：大幅提高初始增益
```javascript
// v95
systemGain.gain.value = 10.0; // ✅ 从2.0x提高到10.0x
```

**理由：**
- YouTube 10%音量 × 10.0x增益 = 100%等效音量
- 确保即使是很小的系统音频也能录到

---

### 修改2：扩大增益范围
```javascript
// v95
const newSystemGain = Math.max(0.5, Math.min(20.0, idealSystemGain));
//                             ↑ 最小0.5x   ↑ 最大20.0x（提高4倍）
```

**理由：**
- 下限从0.3提高到0.5，避免系统音频被压得太小
- 上限从5.0提高到20.0，允许极小音量也能被放大

---

### 修改3：更激进的提升策略
```javascript
// v95
if (systemLevel < 0.3 && systemGain.gain.value < 15.0) {
    systemGain.gain.value = Math.min(20.0, systemGain.gain.value * 1.3);
    //                                ↑ 最大20.0x    ↑ 每次1.3倍（更快）
}
```

**理由：**
- 上限提高到 20.0x
- 提升速度提高到 1.3倍/100ms（比之前快50%）
- 触发阈值提高到 15.0x（允许更高起点）

---

## 📊 对比表

| 参数 | v93-v94 | v95 | 变化 |
|------|---------|-----|------|
| **初始增益** | 2.0x | 10.0x | ⬆️ 5倍 |
| **最小增益** | 0.3x | 0.5x | ⬆️ 67% |
| **最大增益** | 5.0x | 20.0x | ⬆️ 4倍 |
| **提升速度** | 1.2倍 | 1.3倍 | ⬆️ 8% |
| **提升触发** | < 4.0x | < 15.0x | ⬆️ 275% |

---

## 🎯 预期效果

### YouTube 10%音量场景
**v93-v94：**
- 系统音频增益：0.3x - 5.0x
- YouTube 10% × 0.3x = **3%等效音量** ❌ 太小
- YouTube 10% × 5.0x = **50%等效音量** ⚠️ 勉强

**v95：**
- 系统音频增益：0.5x - 20.0x
- YouTube 10% × 10.0x = **100%等效音量** ✅ 正常
- YouTube 10% × 20.0x = **200%等效音量** ✅ 充足

---

### YouTube 50%音量场景
**v93-v94：**
- YouTube 50% × 2.0x = **100%等效音量** ✅
- YouTube 50% × 5.0x = **250%等效音量** ⚠️ 可能过大

**v95：**
- YouTube 50% × 10.0x = **500%等效音量** ⚠️ 初始可能偏大
- 但会被平衡系统压回到 `targetRatio = 0.85`（85%麦克风音量）
- 最终会自动调整到合适值

---

## 🧪 测试计划

### 测试场景1：YouTube 10%音量
```
1. 打开YouTube，音量设置10%
2. 录音：先说话5秒 → 播放YouTube 10秒 → 再说话5秒
3. 观察日志中的系统增益值
4. 转录结果应包含YouTube内容
```

**预期：**
- 初始增益：10.0x
- YouTube播放时：10.0x - 20.0x
- 转录应能识别YouTube音频

---

### 测试场景2：YouTube 50%音量
```
1. 打开YouTube，音量设置50%
2. 录音：先说话5秒 → 播放YouTube 10秒 → 再说话5秒
3. 观察日志中的系统增益值
4. 转录结果应包含YouTube内容
```

**预期：**
- 初始增益：10.0x
- 说话时被压到：0.5x - 2.0x（因为YouTube 50%已经很响）
- YouTube单独播放时：2.0x - 5.0x
- 转录应能识别YouTube音频

---

### 测试场景3：YouTube 90%音量
```
1. 打开YouTube，音量设置90%
2. 录音：先说话5秒 → 播放YouTube 10秒 → 再说话5秒
3. 观察日志中的系统增益值
4. 转录结果应包含YouTube内容
```

**预期：**
- 初始增益：10.0x（可能立即被压到1.0x左右）
- 说话时：0.5x - 1.0x
- YouTube单独播放时：1.0x - 3.0x
- 转录应能识别YouTube音频

---

## 📝 部署信息

**版本：** v95  
**分支：** dev  
**环境：** https://web-dev-9821.up.railway.app  
**部署时间：** 待部署

**关键修改：**
- `static/script.js` (v95)
- `static/index.html` (v95)

---

## 🚀 下一步

1. **部署 v95 到 dev**
2. **按照测试计划测试**
3. **收集日志和转录结果**
4. **如果仍有问题，考虑：**
   - 进一步提高初始增益（15.0x - 20.0x）
   - 完全关闭平衡系统，固定系统增益为10.0x
   - 添加UI音量条，让用户手动调整

---

需要我立即部署 v95 吗？