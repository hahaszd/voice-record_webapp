# 音频片段转录功能测试说明

## 测试程序

已创建两个测试程序：

1. **`test_audio_segment.py`** - 基础测试程序
2. **`test_long_audio_segment.py`** - 增强版测试程序（推荐使用）

## 使用方法

### 方法1: 使用现有音频文件测试

```bash
python test_long_audio_segment.py
```

程序会自动查找以下文件：
- `test_voice.mp3`
- `my-recording.mp3`
- `Record (online-voice-recorder.com).mp3`

如果找到文件，会自动进行测试。

### 方法2: 手动指定音频文件

如果程序未找到音频文件，会提示你输入文件路径：

```bash
python test_long_audio_segment.py
# 然后输入音频文件路径
```

## 测试场景

测试程序会测试以下场景：

1. **转录最后 60 秒** - 测试完整1分钟音频的转录
2. **转录最后 30 秒** - 测试30秒片段的转录
3. **转录最后 10 秒** - 测试10秒片段的转录

## 准备测试音频（超过1分钟）

### 方法1: 使用录音界面录制

1. 访问 `http://localhost:8001/static/index.html`
2. 点击麦克风按钮开始录音
3. 说话超过1分30秒（建议说不同的内容，方便验证截取功能）
4. 停止录音
5. 使用测试程序测试该音频文件

### 方法2: 使用现有长音频文件

如果你有超过1分钟的音频文件，可以直接使用：

```bash
python test_long_audio_segment.py
# 输入你的音频文件路径
```

## 测试输出说明

### 成功输出示例

```
✅ 转录成功!
📝 转录文本 (30 字符):
   我想录几句话，然后试着看Google的API能不能识别出来。
```

### 调试信息

测试程序会显示详细的调试信息：

- **文件信息**: 文件大小、类型、时长
- **请求信息**: API端点、请求参数
- **响应信息**: 状态码、响应时间、转录结果
- **调试信息**: 服务器返回的详细调试信息（如果有）

### 错误处理

如果测试失败，程序会显示：

- HTTP 错误状态码
- 错误响应内容
- 详细的调试信息
- 异常堆栈（如果有）

## 验证截取功能

如果音频文件超过1分钟，测试程序会：

1. **检测音频时长** - 使用 `mutagen` 库检测实际时长
2. **验证截取** - 比较不同时长的转录结果
3. **结果对比** - 如果音频足够长，最后10秒和30秒的内容应该不同

### 预期行为

对于1分30秒的音频：

- **转录最后60秒**: 应该转录中间和最后的内容
- **转录最后30秒**: 应该只转录最后30秒的内容
- **转录最后10秒**: 应该只转录最后10秒的内容

如果截取功能正常，不同时长的转录结果应该不同。

## 注意事项

1. **服务器必须运行**: 确保服务器在 `http://localhost:8001` 运行
2. **音频格式**: 支持 MP3、WAV、WebM 格式
3. **文件大小**: 建议不超过 25MB
4. **网络连接**: 需要能够访问 AI Builder Space API

## 故障排除

### 服务器未运行

```
❌ 无法连接到服务器，请先启动服务器:
   python -m uvicorn server2:app --host 0.0.0.0 --port 8001
```

### 音频文件不存在

```
⚠️  未找到测试音频文件
   请提供音频文件路径
```

### 转录失败

查看详细的错误信息和调试日志，检查：

1. AI Builder Token 是否配置正确
2. 音频文件格式是否支持
3. 文件大小是否超过限制
4. 网络连接是否正常

## 示例测试流程

1. **启动服务器**
   ```bash
   python -m uvicorn server2:app --host 0.0.0.0 --port 8001
   ```

2. **录制测试音频**（使用录音界面）
   - 录制超过1分30秒的音频
   - 保存音频文件

3. **运行测试程序**
   ```bash
   python test_long_audio_segment.py
   ```

4. **查看测试结果**
   - 检查所有测试是否通过
   - 查看转录结果是否正确
   - 验证不同时长的转录结果是否不同

5. **查看详细日志**
   - 服务器终端：查看后端日志
   - 测试程序输出：查看测试详情

## 测试报告

测试程序会在最后生成测试总结：

```
================================================================================
测试总结
================================================================================
转录最后 60 秒: ✅ 成功
转录最后 30 秒: ✅ 成功
转录最后 10 秒: ✅ 成功

总计: 3/3 个测试通过
🎉 所有测试通过！
```

如果所有测试通过，说明音频片段转录功能正常工作。
