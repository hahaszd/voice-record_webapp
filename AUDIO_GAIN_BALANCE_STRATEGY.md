# Audio Gain Balance Strategy

**Date:** 2026-02-06  
**Issue:** 音频混合时的音量平衡问题  
**Status:** ⚠️ 测试中

---

## 🎯 问题描述

在录制**麦克风+系统音频**混合模式时，需要平衡两个音源的音量：
- **系统音频太小** → AI转录时识别不到系统音频内容
- **系统音频太大** → 淹没麦克风声音，麦克风内容转录不清
- **需要找到最佳平衡点**

---

## 📊 音量增益策略对比

### 方案1: 原始配置（v90）
```javascript
micGain.gain.value = 1.0;     // 麦克风 1.0x
systemGain.gain.value = 1.0;  // 系统音频 1.0x
```

**问题：** 系统音频太小，转录时可能被忽略

---

### 方案2: 激进增益（v91, 已废弃）
```javascript
micGain.gain.value = 1.0;     // 麦克风 1.0x
systemGain.gain.value = 2.5;  // 系统音频 2.5x
```

**问题：** 系统音频可能过强，淹没麦克风声音

---

### 方案3: 平衡增益（v91, 当前使用）✅
```javascript
micGain.gain.value = 1.0;     // 麦克风 1.0x
systemGain.gain.value = 1.5;  // 系统音频 1.5x
```

**优点：**
- ✅ 系统音频适度提升（不会太小）
- ✅ 不会淹没麦克风
- ✅ 两者都能清晰录制

---

## 🧪 测试场景

### 场景1: YouTube视频音量正常（50-80%）
**预期：** 
- 麦克风 1.0x + 系统音频 1.5x = 平衡 ✅

### 场景2: YouTube视频音量很小（20-40%）
**可能结果：**
- 系统音频还是不够响
- 需要调整到 2.0x

### 场景3: YouTube视频音量很大（90-100%）
**可能结果：**
- 系统音频 1.5x 可能太响
- 需要调整到 1.2x

### 场景4: 麦克风距离较远
**可能结果：**
- 麦克风音量偏小
- 需要提升麦克风到 1.2-1.5x

---

## 💡 未来改进方案

### 方案A: 自动音量平衡（AI）
使用 Web Audio API 的 `AnalyserNode` 实时检测音量，自动调整增益：

```javascript
// 伪代码
function autoBalance() {
    const micLevel = getMicAudioLevel();    // 0-1
    const systemLevel = getSystemAudioLevel(); // 0-1
    
    // 动态调整增益，保持两者音量接近
    if (systemLevel < micLevel * 0.5) {
        systemGain.gain.value *= 1.2; // 提升系统音频
    }
    if (micLevel < systemLevel * 0.5) {
        micGain.gain.value *= 1.2; // 提升麦克风
    }
}
```

**优点：** 自动适应各种场景  
**缺点：** 实现复杂，可能有延迟

---

### 方案B: 用户可配置（UI控制）⭐ 推荐

添加两个滑块让用户手动调整：

```
🎤 麦克风音量: [====|====] 100%
🔊 系统音频:   [======|==] 150%
```

**优点：**
- ✅ 用户可以根据实际情况调整
- ✅ 实现简单
- ✅ 灵活性最高

**实现位置：** Control Panel（录音控制面板）

---

### 方案C: 预设模式

提供3个预设模式让用户选择：

```
📻 平衡模式（默认）
   麦克风 1.0x, 系统音频 1.5x
   适合大多数场景

🎙️ 麦克风优先
   麦克风 1.2x, 系统音频 1.0x
   适合需要突出自己说话的场景

🔊 系统音频优先
   麦克风 0.8x, 系统音频 2.0x
   适合主要录制视频/播客内容
```

---

## 📊 增益值推荐范围

根据经验和最佳实践：

| 音源 | 最小值 | 推荐值 | 最大值 | 说明 |
|------|--------|--------|--------|------|
| 麦克风 | 0.7x | 1.0x | 1.5x | 太高会爆音 |
| 系统音频 | 1.0x | 1.5x | 2.5x | 取决于源音量 |

**注意：**
- 增益 > 1.0 可能导致失真/爆音
- 增益 < 0.5 可能导致音量过小
- 总和不要超过 3.0-3.5（会过载）

---

## 🔍 如何判断当前设置是否合适

### 方法1: 查看波形
录音时观察波形动画：
- ✅ 两种音源都有明显波动 = 平衡
- ❌ 只有一种有波动 = 不平衡

### 方法2: 查看转录结果
- ✅ 转录包含麦克风 + 系统音频内容 = 成功
- ❌ 只有麦克风或只有系统音频 = 失败

### 方法3: 实时音量监控（开发中）
添加音量表显示：
```
🎤 麦克风:   ▓▓▓▓▓▓▓░░░ 70%
🔊 系统音频: ▓▓▓▓▓░░░░░ 50%
```

---

## 🎯 当前版本（v91）配置

```javascript
麦克风增益:   1.0x  // 保持原音量
系统音频增益: 1.5x  // 适度提升
```

**适用场景：**
- YouTube 音量 50-80%
- 麦克风距离正常（30-50cm）
- 环境噪音不大

**如果不适合：**
- 系统音频还是太小 → 调整到 1.8-2.0x
- 系统音频太大 → 调整到 1.2-1.3x
- 麦克风太小 → 提升麦克风到 1.2-1.3x

---

## 🚀 立即可用的调整方法

如果当前配置不理想，可以快速调整：

### 调整系统音频（保持麦克风不变）
```javascript
// 在 script.js 第 1943 行
systemGain.gain.value = 1.5;  // 改为 1.8 或 2.0 或 1.2
```

### 调整麦克风（保持系统音频不变）
```javascript
// 在 script.js 第 1942 行
micGain.gain.value = 1.0;  // 改为 1.2 或 1.5
```

---

## 📝 测试记录模板

```
测试日期：2026-02-06
测试版本：v91
配置：麦克风 1.0x, 系统音频 1.5x

场景：YouTube视频音量 70%
结果：
- 麦克风内容：✅ 清晰
- 系统音频内容：✅ 清晰
- 平衡度：✅ 良好

场景：YouTube视频音量 30%
结果：
- 麦克风内容：✅ 清晰
- 系统音频内容：❌ 太小
- 建议：提升到 2.0x

场景：YouTube视频音量 100%
结果：
- 麦克风内容：⚠️ 略微被压过
- 系统音频内容：✅ 很响
- 建议：降低到 1.2x
```

---

## ✅ 行动计划

### 短期（立即）
- [x] 调整为平衡增益（1.0x / 1.5x）
- [ ] 部署到 Dev 测试
- [ ] 收集用户反馈
- [ ] 根据反馈调整参数

### 中期（本周）
- [ ] 添加预设模式（3个选项）
- [ ] 添加音量监控UI
- [ ] 在 Help 页面添加说明

### 长期（下个月）
- [ ] 实现自动音量平衡
- [ ] 添加用户自定义滑块
- [ ] 保存用户偏好设置

---

**文档版本:** v1.0  
**最后更新:** 2026-02-06  
**状态:** 等待测试反馈
