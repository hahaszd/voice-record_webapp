# 🎤 语音录制与转录系统

一个基于Web的实时语音录制和转录系统，支持自动录音、自动转录、系统音频捕获等功能。

## ✨ 主要功能

### 🎯 核心功能
- **实时录音**：支持麦克风、系统音频、混合音频三种模式
- **自动转录**：使用AI Builder Space API / Google Speech-to-Text API
- **自动录音**：设置转录时长后自动循环录音和转录
- **无缝录音**：转录期间继续录音，无时间间隙
- **自动复制**：转录完成后自动复制到剪贴板
- **浏览器通知**：页面失焦时转录完成发送通知提醒

### 🔧 技术特性
- **内存优化**：5分钟音频数据自动清理，防止内存泄漏
- **IndexedDB存储**：浏览器本地存储音频chunks
- **音频压缩**：自动压缩超过25MB的音频文件
- **WebM格式**：完整保留音频头部，确保格式正确
- **权限管理**：智能检测和请求麦克风、系统音频、剪贴板、通知权限

### 🎨 用户体验
- **友好的权限请求**：自定义对话框解释权限用途
- **可控开关**：自动录音、自动复制、转录提醒三个独立开关
- **冲突保护**：转录期间禁止停止录音，避免数据冲突
- **音频源锁定**：录音期间禁止切换音频源
- **实时反馈**：录音时间显示、状态提示、进度指示

## 🚀 技术栈

### 前端
- **原生HTML/CSS/JavaScript**（无框架依赖）
- **Web Audio API**：音频捕获和处理
- **MediaRecorder API**：录音功能
- **IndexedDB API**：本地数据存储
- **Notification API**：浏览器通知

### 后端
- **FastAPI**：Python Web框架
- **AI Builder Space Audio API**：音频转录
- **Google Speech-to-Text API**：备用转录服务

## 📦 项目结构

```
d:\Cursor voice record web\
├── server2.py                    # FastAPI后端服务器
├── static/
│   ├── index.html               # 主页面
│   ├── style.css                # 样式表
│   ├── script.js                # 主要业务逻辑
│   └── audio-storage.js         # IndexedDB存储管理
├── .gitignore                   # Git忽略文件
├── README.md                    # 项目文档（本文件）
├── TEST_CHECKLIST.md            # 测试清单（27项测试场景）
├── BROWSER_NOTIFICATION.md      # 通知功能说明
├── NOTIFICATION_ENHANCEMENT.md  # 通知增强功能
├── WEBM_DECODE_ERROR_FIX.md    # WebM解码问题修复
├── SEAMLESS_AUTO_RECORD.md     # 无缝自动录音实现
├── SYSTEM_AUDIO_EXPLANATION.md # 系统音频说明
├── AUDIO_SIZE_OPTIMIZATION.md  # 音频压缩优化
├── AUTO_COPY_FIX.md            # 自动复制修复
├── TRANSCRIPTION_SPEED_ANALYSIS.md # 转录速度分析
├── AUDIO_SOURCE_LOCK.md        # 音频源锁定
├── AUTO_RECORD_WARNING.md      # 自动录音警告
├── DEBUG_WARNING.md            # 调试指南
├── LAYOUT_STABILITY_FIX.md     # 布局稳定性修复
├── CONTEXTUAL_WARNING.md       # 上下文警告
├── DURATION_BUTTON_WARNING.md  # 转录时长按钮警告
├── TRANSCRIPTION_LOCK.md       # 转录锁定机制
└── UI_SIMPLIFICATION.md        # UI简化说明
```

## 🛠️ 安装和运行

### 环境要求
- Python 3.8+
- 现代浏览器（Chrome/Edge/Firefox推荐）
- HTTPS或localhost环境（用于音频和通知API）

### 安装依赖

```bash
pip install fastapi uvicorn python-multipart requests
```

### 运行服务器

```bash
python server2.py
```

服务器将在 `http://localhost:8000` 启动

### 访问应用

在浏览器中打开：`http://localhost:8000`

## 🎮 使用说明

### 基础使用流程

1. **首次访问**
   - 允许麦克风权限
   - 允许通知权限（可选）
   - 选择转录时长（默认5分钟）

2. **开始录音**
   - 点击"开始录音"按钮
   - 开始说话
   - 观察录音时间

3. **停止录音**
   - 点击"停止录音"按钮
   - 自动触发转录
   - 等待20-30秒

4. **查看结果**
   - 转录文本显示在左侧
   - 如果开启"自动复制"，自动复制到剪贴板
   - 如果开启"转录提醒"，失焦时收到通知

### 高级功能

#### 自动录音模式
1. 开启"自动录音"开关
2. 选择转录时长（30秒/1分钟/5分钟）
3. 录音到达时长自动停止并转录
4. 转录完成后自动开始下一轮录音
5. 形成连续的录音转录循环

#### 系统音频录制
1. 选择音频源："仅系统音频"或"麦克风+系统音频"
2. 点击"开始录音"
3. 浏览器弹出窗口，选择要捕获的标签页/窗口/整个屏幕
4. 播放需要录制的音频
5. 停止录音并转录

#### 失焦通知
1. 开启"转录提醒"开关
2. 录音并停止后，切换到其他标签页
3. 转录完成后，系统右下角弹出通知
4. 点击通知返回页面查看结果

## 🧪 测试

详细的测试清单请参考：`TEST_CHECKLIST.md`

测试覆盖：
- ✅ 首次使用流程（5项）
- ✅ 自动录音循环（3项）
- ✅ 音频源切换（3项）
- ✅ 转录冲突处理（2项）
- ✅ 错误处理（3项）
- ✅ 稳定性测试（3项）
- ✅ 浏览器通知（8项）

**总计：27项测试场景**

## 📝 更新日志

### v10 (2026-01-29) - 通知功能增强
- ✨ 添加友好的权限请求对话框
- ✨ 添加页面内"转录提醒"开关
- 🎨 优化权限请求流程
- 📚 新增测试场景（G1-G8）

### v9 (2026-01-29) - 浏览器通知
- ✨ 添加转录完成浏览器通知
- ✨ 失焦时自动提醒用户
- 🎨 通知点击聚焦到页面

### v8 (2026-01-29) - UI简化
- 🎨 移除10秒转录选项
- 🎨 简化转录时长UI（移除按钮，保留checkbox）
- 🎨 移除"默认"文字标签

### v7 (2026-01-29) - 转录冲突保护
- 🐛 修复转录期间停止录音的冲突
- ✨ 转录时禁用停止录音按钮
- ✨ 添加转录进行中的视觉反馈

### v6 (2026-01-29) - 音频源锁定
- 🐛 修复录音时可切换音频源的问题
- ✨ 录音期间禁用音频源选择器
- ✨ 添加友好的提示信息

### v5 (2026-01-28) - 转录速度优化
- 📊 添加转录速度分析和性能日志
- 📚 记录瓶颈分析

### v4 (2026-01-28) - 自动复制修复
- 🐛 修复页面失焦时自动复制失败
- ✨ 添加"点击复制"提示和自动重试

### v3 (2026-01-28) - 音频大小优化
- 🐛 修复音频文件超过25MB的问题
- ✨ 自动压缩音频（16kHz单声道）

### v2 (2026-01-28) - 无缝自动录音
- 🐛 修复自动录音间隙问题
- ✨ 转录期间继续录音

### v1 (2026-01-28) - WebM解码修复
- 🐛 修复长时间录音后的解码错误
- 🐛 修复内存泄漏问题

## 🐛 已知问题

### 系统音频限制
- 浏览器安全策略限制，每次需要用户手动选择音频源
- 无法完全避免选择窗口的弹出
- 用户手动停止共享后需要重新授权

### 浏览器兼容性
- Safari对系统音频支持有限
- 移动端浏览器功能受限
- 通知API需要HTTPS或localhost

### 性能限制
- 转录速度取决于API响应时间（通常20-30秒）
- 长时间录音（>5分钟）会增加处理时间
- IndexedDB有存储限制（通常几百MB）

## 🔒 隐私和安全

- ✅ 所有音频数据仅存储在浏览器本地（IndexedDB）
- ✅ 音频仅在转录时上传到API，不保存在服务器
- ✅ 权限请求透明，用户可随时撤销
- ✅ 转录文本仅保存在浏览器内存中
- ✅ 无第三方追踪和数据收集

## 🤝 贡献

欢迎提交Issue和Pull Request！

## 📄 许可证

MIT License

## 👥 作者

开发者：[Your Name]

## 🙏 致谢

- AI Builder Space - 提供音频转录API
- Google Cloud - 提供备用转录服务
- FastAPI - 优秀的Python Web框架

---

**版本**：v10  
**最后更新**：2026-01-29  
**状态**：MVP准备中 🚀
