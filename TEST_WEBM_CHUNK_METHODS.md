# WebM Chunk处理方式测试指南

## 测试目的

测试不同的音频处理方式，找出哪种方式能够成功生成音频文件并通过API转译。

## 测试场景

### 1. 完整音频文件测试
- **场景**：模拟不删除chunk的情况（WebM文件结构完整）
- **测试**：请求转录10秒、30秒、60秒
- **预期**：应该成功（WebM结构完整，可以解码）

### 2. 服务器端截取测试
- **场景**：模拟删除chunk后浏览器端失败的情况
- **测试**：标记`needs_segmentation=true`，请求服务器端截取
- **预期**：如果ffmpeg可用，应该成功

## 使用方法

### 1. 启动服务器

```bash
python -m uvicorn server2:app --host 0.0.0.0 --port 8001
```

### 2. 准备测试文件

- 录制一个超过60秒的音频文件（使用GUI录制）
- 或使用现有的音频文件（WebM、MP3、WAV格式）

### 3. 运行测试

```bash
python test_webm_chunk_methods.py
```

### 4. 查看结果

测试会输出：
- 每个测试场景的成功/失败状态
- 转录文本预览
- 测试结果汇总
- 成功率统计
- 建议和解决方案

## 测试结果解读

### 情况1: 完整音频测试成功 ✅

**含义**：
- WebM文件结构完整
- 浏览器端可以正常解码和截取

**建议**：
- 不删除chunk，保持WebM文件结构完整
- 这样可以确保浏览器端截取始终成功

### 情况2: 服务器端截取成功 ✅

**含义**：
- WebM文件可能有问题，但服务器端可以处理
- ffmpeg可以成功截取音频

**建议**：
- 删除chunk节省内存
- 浏览器端失败时自动使用服务器端截取
- 需要确保服务器安装了ffmpeg

### 情况3: 所有测试都失败 ❌

**可能原因**：
1. 服务器未正常运行
2. AI Builder Token未配置
3. 音频文件格式不支持
4. ffmpeg未安装（服务器端截取需要）

**解决方法**：
1. 检查服务器日志
2. 确认`.env`文件中的`AI_BUILDER_TOKEN`
3. 确认音频文件格式
4. 安装ffmpeg（如果需要服务器端截取）

## 测试输出示例

```
================================================================================
  WebM Chunk处理方式测试
================================================================================

✅ 服务器连接正常

================================================================================
  查找测试文件
================================================================================

✅ 找到 2 个音频文件:
  1. recording_71s.webm (959.39 KB)
  2. test_voice.mp3 (245.67 KB)

📁 测试文件信息:
  路径: recording_71s.webm
  大小: 959.39 KB (0.94 MB)

================================================================================
  测试场景 1: 完整音频文件，请求10秒（模拟短录音截取）
================================================================================

[测试] 完整音频文件，请求10秒
  文件: recording_71s.webm
  请求时长: 10秒
  文件大小: 959.39 KB
  发送请求到 /transcribe-segment...
  响应状态码: 200
  ✅ 转录成功
  转录文本长度: 25 字符
  转录文本预览: 这是最后10秒的转录文本...

...

================================================================================
  测试结果总结
================================================================================

测试结果汇总:
测试场景                        状态       说明
--------------------------------------------------------------------------------
完整音频_10秒                    ✅ 成功    转录文本长度: 25 字符
完整音频_30秒                    ✅ 成功    转录文本长度: 78 字符
完整音频_60秒                    ✅ 成功    转录文本长度: 156 字符
服务器端截取_10秒                ✅ 成功    转录文本长度: 25 字符
服务器端截取_30秒                ✅ 成功    转录文本长度: 78 字符

📊 分析:
  总测试数: 5
  成功数: 5
  失败数: 0
  成功率: 100.0%

💡 建议:
  ✅ 完整音频和服务器端截取都可以成功转录
  → 建议：
     1. 优先使用浏览器端截取（如果WebM结构完整）
     2. 如果浏览器端失败，自动使用服务器端截取
     3. 删除chunk节省内存，依赖服务器端截取作为备选方案
```

## 注意事项

1. **服务器必须运行**：测试需要连接到`http://localhost:8001`
2. **AI Builder Token必须配置**：检查`.env`文件
3. **音频文件格式**：支持WebM、MP3、WAV等格式
4. **ffmpeg（可选）**：服务器端截取需要ffmpeg，如果未安装会记录警告

## 相关文件

- `test_webm_chunk_methods.py`: 测试脚本
- `server2.py`: 服务器代码（包含`/transcribe-segment`端点）
- `static/script.js`: 前端代码（包含chunk清理逻辑）
