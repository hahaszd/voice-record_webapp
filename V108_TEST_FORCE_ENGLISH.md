# v108 测试版本 - 强制英文模式

## 更新日期
2026-02-09

## 测试目的

**测试在强制英文模式下，中文语音的转录效果**

---

## 修改内容

### api_fallback.py - 所有 API 强制使用英文

#### 1. AI Builder Space API
```python
# 之前（v107）：自动识别
form_data = {
    'model': 'whisper-1',
    'response_format': 'json'
    # 不指定 language，自动识别
}

# 现在（v108-TEST）：强制英文
form_data = {
    'model': 'whisper-1',
    'response_format': 'json',
    'language': 'en'  # 🔴 强制英文
}
```

#### 2. OpenAI Whisper API
```python
# 之前（v107）：自动识别
data = {
    'model': 'whisper-1',
    'response_format': 'json'
    # 不指定 language，自动识别
}

# 现在（v108-TEST）：强制英文
data = {
    'model': 'whisper-1',
    'response_format': 'json',
    'language': 'en'  # 🔴 强制英文
}
```

#### 3. Google Cloud Speech-to-Text API
```python
# 之前（v107）：自动识别
request_body = {
    "config": {
        "encoding": "LINEAR16",
        "sampleRateHertz": 48000,
        # 不指定 languageCode，自动识别
    }
}

# 现在（v108-TEST）：强制英文
request_body = {
    "config": {
        "encoding": "LINEAR16",
        "sampleRateHertz": 48000,
        "languageCode": "en-US",  # 🔴 强制英文
    }
}
```

---

## 日志标识

所有 API 调用都会输出：
```
[v108-TEST] 🔴 强制使用英文模式（测试中文效果）
```

在控制台日志中查找这个标识，确认测试版本生效。

---

## 测试计划

### 测试 1：纯中文语音
```
操作：
1. 选择"麦克风"
2. 说一段纯中文（至少 30 秒）
3. 录音 + 转录

预期结果：
- ❌ 中文无法正确转录
- 可能的情况：
  A. 完全忽略（空白）
  B. 音译成英文（"ni hao" 等）
  C. 识别成英文同音字（"knee how"）
  D. 乱码

记录：实际得到什么结果
```

### 测试 2：纯英文语音
```
操作：
1. 选择"系统音频"
2. 播放英文 YouTube 视频
3. 录音 + 转录

预期结果：
- ✅ 英文正常转录（95%+ 准确度）
- 这是对照组，确认英文模式工作正常

记录：准确度如何
```

### 测试 3：中英混合（先中文）
```
操作：
1. 选择"麦克风"
2. 先说 15 秒中文
3. 再说 15 秒英文
4. 录音 + 转录

预期结果：
- ❌ 中文部分无法正确转录
- ✅ 英文部分正常转录
- 效果：只保留英文部分

记录：中文部分如何处理
```

### 测试 4：中英混合（先英文）
```
操作：
1. 选择"麦克风"
2. 先说 15 秒英文
3. 再说 15 秒中文
4. 录音 + 转录

预期结果：
- ✅ 英文部分正常转录
- ❌ 中文部分无法正确转录

记录：和测试3对比差异
```

---

## 可能的中文转录效果

### 情况 A：完全忽略（最可能）
```
输入：你好，这是一段中文测试。
输出：（空白或只有标点）
```

### 情况 B：拼音音译
```
输入：你好，这是一段中文测试。
输出：ni hao, zhe shi yi duan zhong wen ce shi.
```

### 情况 C：英文同音字
```
输入：你好
输出：knee how 或 nee how
```

### 情况 D：混乱识别
```
输入：你好，这是一段中文测试。
输出：need how just yeah don't jump one send see sure
（随机英文单词）
```

### 情况 E：部分识别
```
输入：你好，这是一段中文测试。Hello, this is English.
输出：... ... ... ... Hello, this is English.
（中文部分空白或乱码）
```

---

## 测试记录模板

### 测试表格

| 测试 | 音频内容 | 实际转录结果 | 准确度 | 类型 |
|-----|---------|------------|-------|------|
| 1 | 纯中文 30秒 | ___________ | __% | A/B/C/D/E |
| 2 | 纯英文 30秒 | ___________ | __% | 对照组 |
| 3 | 中文15s+英文15s | ___________ | __% | ____ |
| 4 | 英文15s+中文15s | ___________ | __% | ____ |

### 详细记录

**测试 1（纯中文）**：
```
说的内容：
"_______________________________________"

转录结果：
"_______________________________________"

观察：
- 中文处理方式：□ 忽略 □ 拼音 □ 同音字 □ 乱码
- 其他发现：
```

**测试 2（纯英文）**：
```
YouTube 内容主题：_______________

转录结果（前100字）：
"_______________________________________"

观察：
- 准确度：约 ____%
- 英文模式工作正常：□ 是 □ 否
```

**测试 3（先中文后英文）**：
```
说的内容：
中文："_______________________"
英文："_______________________"

转录结果：
"_______________________________________"

观察：
- 中文部分：_______________
- 英文部分：_______________
- 过渡处理：_______________
```

**测试 4（先英文后中文）**：
```
说的内容：
英文："_______________________"
中文："_______________________"

转录结果：
"_______________________________________"

观察：
- 英文部分：_______________
- 中文部分：_______________
- 和测试3差异：_______________
```

---

## 测试后的决策

### 如果中文完全无法转录（情况A）
```
结论：强制英文会忽略中文
建议：回滚到 v107（自动识别）
```

### 如果中文变成拼音/同音字（情况B/C）
```
结论：强制英文会曲解中文
建议：回滚到 v107（自动识别）
```

### 如果中文变成乱码（情况D）
```
结论：强制英文产生无意义输出
建议：回滚到 v107（自动识别）
```

### 验证结论
```
问题：在英文模式下，中文是否能被正确识别？
答案：根据测试结果填写
     □ 是（意外！需要进一步验证）
     □ 否（符合预期，需要自动识别）
```

---

## 测试后操作

### 回滚到 v107（自动识别）

如果测试确认中文无法在英文模式下正确转录，使用以下命令回滚：

```bash
# 方法 1：撤销本次修改
git checkout HEAD -- api_fallback.py

# 方法 2：回滚到 v107 commit
git reset --hard <v107-commit-hash>

# 方法 3：手动修改
# 移除所有 'language': 'en' 和 'languageCode': 'en-US'
```

### 或者保留 v108（如果测试效果好）

如果测试发现强制英文效果更好（不太可能），可以：
```bash
git add api_fallback.py
git commit -m "v108: Force English mode for better accuracy"
git push origin dev
```

---

## 控制台日志示例

### 成功的测试日志
```
[FALLBACK] 尝试使用 AI Builder Space API
[v108-TEST] 🔴 强制使用英文模式（测试中文效果）
[INFO] 发送转录请求...
[INFO] 服务器响应: 200
[INFO] 转录完成

转录结果：
（这里会显示实际转录的文本）
```

查找 `[v108-TEST] 🔴` 标识，确认测试版本生效。

---

## 重要提醒

### ⚠️ 这是测试版本
- 仅用于验证"强制英文 vs 自动识别"的效果
- **不建议部署到生产环境**
- 测试完成后应该回滚

### ⚠️ 用户影响
- 如果部署到 dev 环境，所有用户都会受影响
- 中文用户会发现转录失败
- 建议：
  - 只在本地测试
  - 或在 dev 环境快速测试后立即回滚

### ⚠️ 测试时间
- 建议测试时间：< 30 分钟
- 完成测试后立即恢复 v107

---

## 预期测试结果

### 最可能的结果（基于理论）

**纯中文**：
- 准确度：0-20%（基本无法使用）
- 效果：忽略或音译

**纯英文**：
- 准确度：95-98%（正常）
- 效果：完全正常

**混合语言**：
- 英文部分：95-98%（正常）
- 中文部分：0-20%（几乎无法使用）

**结论**：
- v107（自动识别）比 v108（强制英文）更好
- 应该回滚到 v107

---

## 测试 Checklist

- [ ] 代码已修改（api_fallback.py）
- [ ] 本地测试环境已启动
- [ ] 控制台能看到 `[v108-TEST] 🔴` 标识
- [ ] 完成测试 1（纯中文）
- [ ] 完成测试 2（纯英文）
- [ ] 完成测试 3（先中文后英文）
- [ ] 完成测试 4（先英文后中文）
- [ ] 记录所有测试结果
- [ ] 做出决策（保留 or 回滚）
- [ ] 执行回滚（如果需要）
- [ ] 确认回滚成功

---

**版本**：v108-TEST  
**状态**：⚠️ 测试版本，仅用于验证  
**建议**：测试完成后回滚到 v107  
**测试人**：_______________  
**测试日期**：2026-02-09
