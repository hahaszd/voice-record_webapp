# 录音功能自动化测试

## 概述

这个测试套件用于自动化测试录音和播放功能，确保代码修改后功能正常。

## 测试用例

1. **5秒录音测试** - 测试5秒录音是否可以正常播放
2. **8秒录音测试** - 测试8秒录音是否可以正常播放
3. **15秒录音测试** - 测试15秒录音是否可以正常播放（超过10秒限制）

## 前置要求

1. **Node.js** - 需要安装Node.js（推荐v16+）
   ```bash
   # 检查Node.js是否已安装
   node --version
   ```

2. **Python** - 需要Python 3.7+
   ```bash
   # 检查Python是否已安装
   python --version
   ```

3. **FastAPI服务器** - 测试会自动启动服务器

## 安装依赖

### 1. 安装Node.js依赖

```bash
npm install
```

这会安装Puppeteer（浏览器自动化工具）。

### 2. 安装Python依赖

```bash
pip install -r requirements.txt
```

## 运行测试

### 方法1: 使用Python测试运行器（推荐）

```bash
python test_runner.py
```

这个脚本会：
1. 检查Node.js是否已安装
2. 自动安装npm依赖（如果需要）
3. 启动FastAPI服务器
4. 运行所有测试用例
5. 自动停止服务器

### 方法2: 手动运行

#### 步骤1: 启动服务器

```bash
python -m uvicorn server2:app --host 0.0.0.0 --port 8001
```

#### 步骤2: 运行测试

在另一个终端中运行：

```bash
npm test
```

## 测试输出

测试会输出详细的日志信息，包括：
- 每个测试步骤的执行情况
- 浏览器控制台的错误和警告
- 测试结果摘要

### 示例输出

```
============================================================
开始运行录音播放测试
服务器地址: http://localhost:8001
测试用例数量: 3
============================================================

============================================================
开始测试: 5秒录音测试
描述: 测试5秒录音是否可以正常播放
预期录音时长: 5秒
预期可以播放: 是
============================================================

[1/6] 访问页面: http://localhost:8001
[2/6] 页面标题: 语音录制与转录
[3/6] 点击开始录音按钮
[4/6] 录音状态: 正在录音中...
[5/6] 录音中... (5秒)
[6/6] 点击停止录音按钮
录音状态: 录音已停止
显示的录音时长: 00:05
点击"转录最后10秒"按钮
操作按钮区域已显示
点击"播放转录音频"按钮
✅ 测试通过: 音频正在播放

============================================================
测试结果摘要
============================================================

1. 5秒录音测试: ✅ 通过
   录音时长: 5秒
   预期播放: 是
   实际播放: 是

2. 8秒录音测试: ✅ 通过
   录音时长: 8秒
   预期播放: 是
   实际播放: 是

3. 15秒录音测试: ✅ 通过
   录音时长: 15秒
   预期播放: 是
   实际播放: 是

============================================================
总计: 3 个测试
通过: 3 个
失败: 0 个
============================================================
```

## 测试流程

每个测试用例会执行以下步骤：

1. 打开浏览器并访问测试页面
2. 点击"开始录音"按钮
3. 等待指定时长（5秒、8秒或15秒）
4. 点击"停止录音"按钮
5. 点击"转录最后10秒"按钮
6. 点击"播放转录音频"按钮
7. 验证音频是否可以正常播放

## 故障排除

### 问题1: Node.js未安装

**错误**: `❌ Node.js未安装，请先安装Node.js`

**解决**: 安装Node.js
- Windows: 从 https://nodejs.org/ 下载安装
- macOS: `brew install node`
- Linux: `sudo apt-get install nodejs npm`

### 问题2: 服务器启动失败

**错误**: `❌ 服务器启动超时`

**解决**: 
1. 检查端口8001是否被占用
2. 确保所有Python依赖已安装
3. 检查server2.py文件是否存在

### 问题3: 测试失败

**可能原因**:
1. 服务器未正常运行
2. 浏览器无法访问页面
3. 页面元素未找到
4. 音频播放功能异常

**调试方法**:
1. 手动访问 http://localhost:8001 确认页面正常
2. 查看浏览器控制台的错误信息
3. 检查测试日志中的详细错误信息

## 持续集成

可以在代码修改后自动运行测试：

```bash
# 每次修改代码后运行
python test_runner.py
```

或者添加到Git hooks中：

```bash
# .git/hooks/pre-commit
#!/bin/bash
python test_runner.py
```

## 注意事项

1. 测试会打开浏览器窗口（headless: false），方便观察测试过程
2. 测试需要麦克风权限，但Puppeteer无法实际录制音频，所以测试主要验证UI交互
3. 实际音频播放测试需要真实的浏览器环境，可能需要手动验证

## 扩展测试

可以修改 `test_recording.js` 中的 `testCases` 数组来添加更多测试用例：

```javascript
const testCases = [
    {
        name: '自定义测试',
        duration: 12,
        shouldPlay: true,
        description: '测试描述'
    }
];
```
